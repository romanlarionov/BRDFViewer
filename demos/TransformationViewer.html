<!DOCTYPE html>
<html>
	<head>
		<meta charset=utf-8>
		<title>Ideal Mirror Reflection Program</title>
		<style>
			body { margin: 0; }
			canvas { width: 100%; height: 100% }
		</style>
	</head>
	<body>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r80/three.min.js"></script>
    <script src="https://dl.dropboxusercontent.com/u/3587259/Code/Threejs/OrbitControls.js"></script>
	<script src="../lib/DDSLoader.js" type="text/javascript"></script>
	<script src="../lib/KeyboardState.js" type="text/javascript"></script>
    <script src='../lib/DAT.GUI.min.js' type='text/javascript'></script>
	<script src="../src/js/model.js" type="text/javascript"></script>
	<script src="../src/js/shader.js" type="text/javascript"></script>
    <script>
        // Set up three.js render context
        var scene = new THREE.Scene();
        var camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 2000);
        camera.position.set(0.0, 5.0, 5.0);
        var cameraSpeed = 10;
        var clock = new THREE.Clock();
        var deltaTime;
        
        var ambient = new THREE.AmbientLight(0xFFFFFF);
		scene.add(ambient);

        var renderer = new THREE.WebGLRenderer();
        renderer.setSize(window.innerWidth, window.innerHeight);
        window.addEventListener("resize", onWindowResize, false);
        document.body.appendChild(renderer.domElement);
        scene.background = new THREE.Color(0x3C5C67);

        // User Input
        var keyboard = new THREEx.KeyboardState();
        var controls = new THREE.OrbitControls(camera, renderer.domElement);
		controls.enableDamping = true;
		controls.dampingFactor = 0.25;
		controls.enableZoom = false;

        // Scene objects
	    scene.add( new THREE.AxisHelper() );

        var wireframeMaterial = new THREE.MeshBasicMaterial( { color: 0xFFFFFF, side:THREE.DoubleSide } ); 
	    /*var squareGeometry = new THREE.PlaneGeometry(1,1,10,10);
	    var square = new THREE.Mesh(squareGeometry, wireframeMaterial);
	    var square2 = new THREE.Mesh(squareGeometry, wireframeMaterial);
        scene.add(square);
        scene.add(square2);*/

        var textureLoader = new THREE.TextureLoader();
        var ltc_invM_tex = textureLoader.load("../assets/ltc_Minv.png");
        var ltc_mag_tex = textureLoader.load("../assets/ltc_Amp.png");

        var basicMaterial = new Shader("transformation", {
            roughness : {type: 'f', value: 0.3 },
            theta : {type: 'f', value: Math.PI / 4},
            ltc_Minv : {type: 't', value: ltc_invM_tex },
            ltc_Amp : {type: 't', value: ltc_mag_tex }
        });

        var squareGeometry = new THREE.Geometry();
        squareGeometry.vertices.push(new THREE.Vector3(0, 0, 0));
        squareGeometry.vertices.push(new THREE.Vector3(0, 1, 0));
        squareGeometry.vertices.push(new THREE.Vector3(1, 1, 0));
        squareGeometry.vertices.push(new THREE.Vector3(0, 0, 0));
        squareGeometry.vertices.push(new THREE.Vector3(1, 1, 0));
        squareGeometry.vertices.push(new THREE.Vector3(1, 0, 0));
        squareGeometry.faces.push(new THREE.Face3(0, 1, 2));
        squareGeometry.faces.push(new THREE.Face3(3, 4, 5));
        squareGeometry.computeVertexNormals();
        var square = new THREE.Mesh(squareGeometry, wireframeMaterial);
        square.position.set(-5, 0, 0);
        scene.add(square);

        var square2 = new THREE.Mesh(squareGeometry, basicMaterial.material);
        square2.position.set(0, 5, -5);
        //square2.scale.set(10, 10, 10);
        scene.add(square2);

        var ddsLoader = new THREE.DDSLoader();

        function updateScene()
        {
            if (ltc_invM_tex.image !== undefined)
            {
                var t = textureLoader;
                //var Minv = ltc_invM_tex
                //for (var i = 0; i < 6; i++)
                //{
                //    square2.geometry.vertices[i] =  square2.geometry.vertices[i];
                //}
            }
        }

        // Render
        function render() {
            requestAnimationFrame(render);
            checkInput();
            updateScene();
            renderer.render(scene, camera);
        }

        function onWindowResize(event) {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innderHeight);
        }

        function checkInput() {
            delta = clock.getDelta();

            if (keyboard.pressed('W'))
                camera.position.z -= cameraSpeed * delta;

            if (keyboard.pressed('A')) 
                camera.position.x -= cameraSpeed * delta;
   
            if (keyboard.pressed('S'))
                camera.position.z += cameraSpeed * delta;

            if (keyboard.pressed('D'))
                camera.position.x += cameraSpeed * delta;

            controls.update();
        }

        function setupGUI() {
            var gui = new dat.GUI({
                height: 5 * 32 - 1
            });

            var params = {
                roughness: 0.3,
                theta: Math.PI / 4.0
            }

            gui.add(params, "roughness", 0.0, 1.0).onChange(function(r) {
                square2.material.uniforms["roughness"] = {type: 'f', value: r };
            });

            gui.add(params, "theta", 0.0, Math.PI / 2.0).onChange(function(t) {
                square2.material.uniforms["theta"] = {type: 'f', value: t };
            });
        }

        setupGUI();
        render();
	</script>
	</body>
</html>